const path = require('path')
const simpleGit = require('simple-git/promise')
const git = simpleGit(path.join(__dirname, '../..'))

const hasNoErrors = async fn => {
  try {
    await git[fn]()
    return true
  } catch (err) {
    return false
  }
}

const run = async () => {

  const isRepo = await git.checkIsRepo()
  if (!isRepo) { return console.log('Not a git repository, please init and create your first commit') }
  //Init?await git.init(), git.add() git.commit()

  const hasCommitHistory = await hasNoErrors('log')
  if(!hasCommitHistory) { return console.log('Has no commit history, please stage your files and make an initial commit') }
  //Commit?

  const status = await git.status()
  if (status.modified.length || status.created.length) { return console.log('You have uncommited changes, please add and commit and try again.') }

  const hasRemote = await hasNoErrors('listRemote')
  if(!hasRemote) { return console.log('Couldn\'t find a remote repository, please link a remote repo') }
  //Ask for remote?



  //Check .gitignore

  await git.checkout(['--orphan', 'review'])
  await git.raw(['rm', '-rf', '.'])
  await git.commit('first commit', { "--allow-empty": true })
  await git.raw(['rebase', '--onto', 'review', '--root', 'master'])
  await git.push('origin', 'master', { "--force": true })
  await git.checkout(['review'])
  await git.push('origin', 'review', { "--force": true })
  await git.checkout(['master'])

  console.log('All good, you can now create your pull request on Github :)')

  //Use the Github API to create PR automatically
}

run()

//"review": "node node_modules/elevation-pr/index.js"
//Make a script add automatically